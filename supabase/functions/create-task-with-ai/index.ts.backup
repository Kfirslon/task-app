// Setup type definitions for built-in Supabase Runtime APIs
import "jsr:@supabase/functions-js/edge-runtime.d.ts";
import { createClient } from "jsr:@supabase/supabase-js@2";
import OpenAI from "npm:openai";

// Load environment variables
const SUPABASE_URL = Deno.env.get("SUPABASE_URL") ?? "";
const SUPABASE_ANON_KEY = Deno.env.get("SUPABASE_ANON_KEY") ?? "";
const OPENAI_API_KEY = Deno.env.get("OPENAI_API_KEY");

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Methods": "POST",
  "Access-Control-Allow-Headers":
    "authorization, x-client-info, apikey, content-type",
};

Deno.serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { status: 204, headers: corsHeaders });
  }

  try {
    const { title, description } = await req.json();
    console.log("ðŸ”„ Creating task with AI suggestions...");

    const authHeader = req.headers.get("Authorization");
    if (!authHeader) {
      throw new Error("No authorization header");
    }

    // Initialize Supabase client
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      global: {
        headers: { Authorization: authHeader },
      },
    });

    // Get user session
    const {
      data: { user },
    } = await supabaseClient.auth.getUser();
    if (!user) throw new Error("No user found");

    // Initialize OpenAI
    const openai = new OpenAI({
      apiKey: OPENAI_API_KEY,
    });

    // Enhanced AI prompt for multiple insights
    const aiPrompt = `Analyze this task and provide insights in JSON format:
Task: "${title}"
Description: "${description || 'No description provided'}"

Provide a JSON response with:
1. "label": ONE of these categories: work, personal, priority, shopping, home
2. "priority": high, medium, or low based on urgency/importance
3. "estimated_time": estimated minutes to complete (number only)
4. "suggestion": a brief helpful tip for completing this task

Respond with ONLY valid JSON, no other text.`;

    const completion = await openai.chat.completions.create({
      messages: [{ role: "user", content: aiPrompt }],
      model: "gpt-4o-mini",
      temperature: 0.3,
      max_tokens: 150,
    });

    let aiResponse;
    try {
      const responseText = completion.choices[0].message.content?.trim() || "{}";
      aiResponse = JSON.parse(responseText);
      console.log("âœ¨ AI Response:", aiResponse);
    } catch (parseError) {
      console.error("Failed to parse AI response, using defaults");
      aiResponse = {
        label: "personal",
        priority: "medium",
        estimated_time: 30,
        suggestion: "Break this task into smaller steps for better progress."
      };
    }

    // Validate and sanitize AI response
    const validLabels = ["work", "personal", "priority", "shopping", "home"];
    const validPriorities = ["high", "medium", "low"];
    
    const label = validLabels.includes(aiResponse.label) ? aiResponse.label : null;
    const priority = validPriorities.includes(aiResponse.priority) ? aiResponse.priority : "medium";
    const estimated_time = typeof aiResponse.estimated_time === "number" && aiResponse.estimated_time > 0
      ? Math.min(aiResponse.estimated_time, 480) // Cap at 8 hours
      : 30;

    // Store full AI insights
    const ai_insights = {
      suggestion: aiResponse.suggestion || "Focus on one task at a time.",
      analyzed_at: new Date().toISOString(),
      confidence: "high"
    };

    // Create the task with AI enhancements
    const { data, error } = await supabaseClient
      .from("tasks")
      .insert({
        title,
        description,
        completed: false,
        user_id: user.id,
        label,
        priority,
        estimated_time,
        ai_insights
      })
      .select()
      .single();

    if (error) throw error;

    console.log(`âœ… Task created with AI insights: Priority=${priority}, Time=${estimated_time}min, Label=${label}`);

    return new Response(JSON.stringify(data), {
      headers: {
        "Content-Type": "application/json",
        "Access-Control-Allow-Origin": "*",
      },
    });
  } catch (error) {
    console.error("Error in create-task-with-ai:", error.message);
    return new Response(JSON.stringify({ error: error.message }), {
      status: 400,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});